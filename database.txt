-- Phần 1: Tạo database và chuyển sang sử dụng database đó
USE master;
GO

IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = N'MYPROTEIN')
BEGIN
    CREATE DATABASE MYPROTEIN;
END
GO

USE MYPROTEIN;
GO

-- Phần 2: Xóa các bảng cũ theo thứ tự chính xác
IF OBJECT_ID('dbo.cart_items', 'U') IS NOT NULL DROP TABLE dbo.cart_items;
IF OBJECT_ID('dbo.order_items', 'U') IS NOT NULL DROP TABLE dbo.order_items;
IF OBJECT_ID('dbo.product_images', 'U') IS NOT NULL DROP TABLE dbo.product_images;
IF OBJECT_ID('dbo.reviews', 'U') IS NOT NULL DROP TABLE dbo.reviews;
IF OBJECT_ID('dbo.refunds', 'U') IS NOT NULL DROP TABLE dbo.refunds;
IF OBJECT_ID('dbo.wishlist_items', 'U') IS NOT NULL DROP TABLE dbo.wishlist_items;
IF OBJECT_ID('dbo.product_variants', 'U') IS NOT NULL DROP TABLE dbo.product_variants;
IF OBJECT_ID('dbo.orders', 'U') IS NOT NULL DROP TABLE dbo.orders;
IF OBJECT_ID('dbo.addresses', 'U') IS NOT NULL DROP TABLE dbo.addresses;
IF OBJECT_ID('dbo.carts', 'U') IS NOT NULL DROP TABLE dbo.carts;
IF OBJECT_ID('dbo.wishlists', 'U') IS NOT NULL DROP TABLE dbo.wishlists;
IF OBJECT_ID('dbo.products', 'U') IS NOT NULL DROP TABLE dbo.products;
IF OBJECT_ID('dbo.categories', 'U') IS NOT NULL DROP TABLE dbo.categories;
IF OBJECT_ID('dbo.users', 'U') IS NOT NULL DROP TABLE dbo.users;
IF OBJECT_ID('dbo.admins', 'U') IS NOT NULL DROP TABLE dbo.admins;
IF OBJECT_ID('dbo.weights', 'U') IS NOT NULL DROP TABLE dbo.weights;
IF OBJECT_ID('dbo.flavours', 'U') IS NOT NULL DROP TABLE dbo.flavours;
IF OBJECT_ID('dbo.payment_methods', 'U') IS NOT NULL DROP TABLE dbo.payment_methods;
IF OBJECT_ID('dbo.delivery_types', 'U') IS NOT NULL DROP TABLE dbo.delivery_types;
IF OBJECT_ID('dbo.manufacturers', 'U') IS NOT NULL DROP TABLE dbo.manufacturers;
GO

-- Phần 3: Tạo Cấu trúc Bảng (Schema Definition)
CREATE TABLE [users] (
  [user_id] int PRIMARY KEY IDENTITY(1, 1),
  [username] varchar(50) UNIQUE NOT NULL,
  [full_name] nvarchar(100) NOT NULL,
  [email] varchar(100) UNIQUE NOT NULL,
  [password_hash] varchar(255) NOT NULL,
  [phone] varchar(20),
  [avatar_url] varchar(255),
  [created_at] datetime DEFAULT (getdate()),
  [updated_at] datetime
);
GO
CREATE TABLE [addresses] (
  [address_id] int PRIMARY KEY IDENTITY(1, 1),
  [user_id] int NOT NULL,
  [full_name] nvarchar(100) NOT NULL,
  [address] nvarchar(255) NOT NULL,
  [city] nvarchar(100),
  [province] nvarchar(100),
  [phone] char(10) NOT NULL,
  [is_default] bit DEFAULT (0)
);
GO
CREATE TABLE [categories] (
  [category_id] int PRIMARY KEY IDENTITY(1, 1),
  [name] nvarchar(100) NOT NULL
);
GO
CREATE TABLE [manufacturers] (
  [manufacturer_id] int PRIMARY KEY IDENTITY(1, 1),
  [name] nvarchar(100) NOT NULL,
  [country] nvarchar(100)
);
GO
CREATE TABLE [products] (
  [product_id] int PRIMARY KEY IDENTITY(1, 1),
  [sku] varchar(50) UNIQUE NOT NULL,
  [category_id] int,
  [manufacturer_id] int,
  [name] nvarchar(150) NOT NULL,
  [description] nvarchar(max),
  [price] int NOT NULL DEFAULT (0),
  [sale_price] int,
  [image_url] varchar(255),
  [total_all_time] int DEFAULT(0),
  [status] bit DEFAULT (1),
  [created_at] datetime DEFAULT (getdate())
);
GO
CREATE TABLE [product_images] (
  [image_id] int PRIMARY KEY IDENTITY(1, 1),
  [product_id] int NOT NULL,
  [image_url] varchar(255) NOT NULL,
  [alt_text] nvarchar(255)
);
GO
CREATE TABLE [weights] (
  [weight_id] int PRIMARY KEY IDENTITY(1, 1),
  [weight_value] float UNIQUE NOT NULL,
  [servings] int
);
GO
CREATE TABLE [flavours] (
  [flavour_id] int PRIMARY KEY IDENTITY(1, 1),
  [flavour_name] nvarchar(50) UNIQUE NOT NULL
);
GO
CREATE TABLE [product_variants] (
  [variant_id] int PRIMARY KEY IDENTITY(1, 1),
  [product_id] int NOT NULL,
  [weight_id] int,
  [flavour_id] int,
  [price] int,
  [image_url] varchar(255),
  [stock_quantity] int NOT NULL DEFAULT (0)
);
GO
CREATE TABLE [carts] (
  [cart_id] int PRIMARY KEY IDENTITY(1, 1),
  [user_id] int NOT NULL
);
GO
CREATE TABLE [cart_items] (
  [item_id] int PRIMARY KEY IDENTITY(1, 1),
  [cart_id] int NOT NULL,
  [variant_id] int NOT NULL,
  [quantity] int NOT NULL
);
GO
CREATE TABLE [payment_methods] (
  [payment_method_id] int PRIMARY KEY IDENTITY(1, 1),
  [name] nvarchar(100) NOT NULL,
  [description] nvarchar(max),
  [status] bit DEFAULT (1)
);
GO
CREATE TABLE [delivery_types] (
  [id] int PRIMARY KEY IDENTITY(1, 1),
  [name] nvarchar(100) NOT NULL,
  [fee] int NOT NULL,
  [description] nvarchar(max),
  [status] bit DEFAULT (1)
);
GO
CREATE TABLE [orders] (
  [order_id] int PRIMARY KEY IDENTITY(1, 1),
  [user_id] int NOT NULL,
  [order_date] datetime DEFAULT (getdate()),
  [status] nvarchar(50) NOT NULL CHECK ([status] IN (N'chờ thành toán', N'đã thanh toán', N'đã trả', N'đã hủy', N'hoàn thành')),
  [address_id] int NOT NULL,
  [payment_method_id] int NOT NULL,
  [delivery_type_id] int NOT NULL,
  [tax] decimal(5, 2) DEFAULT 0.01,
  [notes] nvarchar(max),
  [created_at] datetime DEFAULT (getdate())
);
GO
CREATE TABLE [order_items] (
  [order_item_id] int PRIMARY KEY IDENTITY(1, 1),
  [order_id] int NOT NULL,
  [variant_id] int NOT NULL,
  [quantity] int NOT NULL
);
GO
CREATE TABLE [reviews] (
  [review_id] int PRIMARY KEY IDENTITY(1, 1),
  [product_id] int NOT NULL,
  [user_id] int NOT NULL,
  [rating] int NOT NULL,
  [comment] nvarchar(max),
  [created_at] datetime DEFAULT (getdate())
);
GO
CREATE TABLE [wishlists] (
  [wishlist_id] int PRIMARY KEY IDENTITY(1, 1),
  [user_id] int UNIQUE NOT NULL
);
GO
CREATE TABLE [wishlist_items] (
  [id] int PRIMARY KEY IDENTITY(1, 1),
  [wishlist_id] int NOT NULL,
  [product_id] int NOT NULL
);
GO
CREATE TABLE [refunds] (
  [refund_id] int PRIMARY KEY IDENTITY(1, 1),
  [order_id] int NOT NULL,
  [reason] nvarchar(max) NOT NULL,
  [status] varchar(50) DEFAULT 'Pending',
  [created_at] datetime DEFAULT (getdate())
);
GO
CREATE TABLE [admins] (
  [admin_id] int PRIMARY KEY IDENTITY(1, 1),
  [username] varchar(50) UNIQUE NOT NULL,
  [password_hash] varchar(255) NOT NULL,
  [created_at] datetime DEFAULT (getdate())
);
GO

-- Phần 4: Định nghĩa các Khóa Ngoại
ALTER TABLE [addresses] ADD FOREIGN KEY ([user_id]) REFERENCES [users] ([user_id]) ON DELETE CASCADE;
GO
ALTER TABLE [products] ADD FOREIGN KEY ([category_id]) REFERENCES [categories] ([category_id]) ON DELETE SET NULL;
GO
ALTER TABLE [products] ADD FOREIGN KEY ([manufacturer_id]) REFERENCES [manufacturers] ([manufacturer_id]) ON DELETE SET NULL;
GO
ALTER TABLE [product_images] ADD FOREIGN KEY ([product_id]) REFERENCES [products] ([product_id]) ON DELETE CASCADE;
GO
ALTER TABLE [product_variants] ADD FOREIGN KEY ([product_id]) REFERENCES [products] ([product_id]) ON DELETE CASCADE;
GO
ALTER TABLE [product_variants] ADD FOREIGN KEY ([weight_id]) REFERENCES [weights] ([weight_id]) ON DELETE SET NULL;
GO
ALTER TABLE [product_variants] ADD FOREIGN KEY ([flavour_id]) REFERENCES [flavours] ([flavour_id]) ON DELETE SET NULL;
GO
ALTER TABLE [carts] ADD FOREIGN KEY ([user_id]) REFERENCES [users] ([user_id]) ON DELETE CASCADE;
GO
ALTER TABLE [cart_items] ADD FOREIGN KEY ([cart_id]) REFERENCES [carts] ([cart_id]) ON DELETE CASCADE;
GO
ALTER TABLE [cart_items] ADD FOREIGN KEY ([variant_id]) REFERENCES [product_variants] ([variant_id]) ON DELETE NO ACTION;
GO
ALTER TABLE [orders] ADD FOREIGN KEY ([user_id]) REFERENCES [users] ([user_id]) ON DELETE NO ACTION;
GO
ALTER TABLE [orders] ADD FOREIGN KEY ([address_id]) REFERENCES [addresses] ([address_id]) ON DELETE NO ACTION;
GO
ALTER TABLE [orders] ADD FOREIGN KEY ([payment_method_id]) REFERENCES [payment_methods] ([payment_method_id]) ON DELETE NO ACTION;
GO
ALTER TABLE [orders] ADD FOREIGN KEY ([delivery_type_id]) REFERENCES [delivery_types] ([id]) ON DELETE NO ACTION;
GO
ALTER TABLE [order_items] ADD FOREIGN KEY ([order_id]) REFERENCES [orders] ([order_id]) ON DELETE CASCADE;
GO
ALTER TABLE [order_items] ADD FOREIGN KEY ([variant_id]) REFERENCES [product_variants] ([variant_id]) ON DELETE NO ACTION;
GO
ALTER TABLE [reviews] ADD FOREIGN KEY ([product_id]) REFERENCES [products] ([product_id]) ON DELETE CASCADE;
GO
ALTER TABLE [reviews] ADD FOREIGN KEY ([user_id]) REFERENCES [users] ([user_id]) ON DELETE CASCADE;
GO
ALTER TABLE [wishlists] ADD FOREIGN KEY ([user_id]) REFERENCES [users] ([user_id]) ON DELETE CASCADE;
GO
ALTER TABLE [wishlist_items] ADD FOREIGN KEY ([wishlist_id]) REFERENCES [wishlists] ([wishlist_id]) ON DELETE CASCADE;
GO
ALTER TABLE [wishlist_items] ADD FOREIGN KEY ([product_id]) REFERENCES [products] ([product_id]) ON DELETE CASCADE;
GO
ALTER TABLE [refunds] ADD FOREIGN KEY ([order_id]) REFERENCES [orders] ([order_id]) ON DELETE NO ACTION;
GO

-- Phần 5: Chèn dữ liệu mẫu lớn
PRINT 'Starting data insertion process...';
GO

-- Dữ liệu cơ bản
PRINT 'Inserting base data...';
INSERT INTO categories (name) VALUES (N'Whey Protein'),(N'Mass Gainer'),(N'Creatine'),(N'Pre-Workout'),(N'BCAA & EAA');
INSERT INTO manufacturers (name, country) VALUES (N'Optimum Nutrition', 'USA'),(N'Myprotein', 'UK'),(N'MuscleTech', 'USA'), (N'Dymatize', 'USA'), (N'BSN', 'USA');
INSERT INTO weights (weight_value, servings) VALUES (0.5, 15), (1.0, 30), (2.27, 74), (5.4, 149);
INSERT INTO flavours (flavour_name) VALUES (N'Double Rich Chocolate'),(N'Vanilla Ice Cream'),(N'Strawberry'),(N'Unflavored'),(N'Fruit Punch'), (N'Cookies & Cream');
INSERT INTO payment_methods (name, description) VALUES (N'Thanh toán khi nhận hàng (COD)', N'Trả tiền mặt khi shipper giao hàng'), (N'Chuyển khoản ngân hàng', N'Chuyển khoản qua số tài khoản được cung cấp');
INSERT INTO delivery_types (name, fee, description) VALUES (N'Giao hàng tiêu chuẩn', 30000, N'Dự kiến 2-4 ngày'), (N'Giao hàng hỏa tốc', 50000, N'Trong vòng 24h');
INSERT INTO admins (username, password_hash) VALUES ('admin', 'admin123'); -- Mật khẩu cần được hash trong thực tế
GO

-- Chèn 50 sản phẩm thực tế và biến thể
PRINT 'Inserting 50 products and their variants...';
-- 15 SẢN PHẨM THỰC TẾ
DECLARE @CatWhey INT = (SELECT category_id FROM categories WHERE name = N'Whey Protein');
DECLARE @CatMass INT = (SELECT category_id FROM categories WHERE name = N'Mass Gainer');
DECLARE @CatCreatine INT = (SELECT category_id FROM categories WHERE name = N'Creatine');
DECLARE @CatPre INT = (SELECT category_id FROM categories WHERE name = N'Pre-Workout');
DECLARE @CatBCAA INT = (SELECT category_id FROM categories WHERE name = N'BCAA & EAA');

DECLARE @ManuON INT = (SELECT manufacturer_id FROM manufacturers WHERE name = N'Optimum Nutrition');
DECLARE @ManuMP INT = (SELECT manufacturer_id FROM manufacturers WHERE name = N'Myprotein');
DECLARE @ManuMT INT = (SELECT manufacturer_id FROM manufacturers WHERE name = N'MuscleTech');
DECLARE @ManuDY INT = (SELECT manufacturer_id FROM manufacturers WHERE name = N'Dymatize');
DECLARE @ManuBSN INT = (SELECT manufacturer_id FROM manufacturers WHERE name = N'BSN');

-- Whey
INSERT INTO products (sku, name, description, price, sale_price, category_id, manufacturer_id, image_url) VALUES ('ON_GSW_5', N'Gold Standard 100% Whey', N'Whey Protein bán chạy nhất thế giới, cung cấp 24g protein mỗi lần dùng.', 1750000, 1699000, @CatWhey, @ManuON, '/images/products/on_gold_standard.jpg');
DECLARE @p1 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p1, 1, 3, 100), (@p1, 2, 3, 85);

INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('MP_IW_2.5', N'Impact Whey Protein', N'Sản phẩm whey protein giá trị cao từ Myprotein, cung cấp 21g protein mỗi lần dùng.', 1400000, @CatWhey, @ManuMP, '/images/products/mp_impact_whey.jpg');
DECLARE @p2 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p2, 2, 3, 120), (@p2, 3, 3, 90);

INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('DY_ISO100_5', N'ISO 100 Hydrolyzed', N'Whey protein isolate và hydrolyzed siêu tinh khiết, hấp thụ nhanh, lý tưởng sau tập.', 2100000, @CatWhey, @ManuDY, '/images/products/dy_iso100.jpg');
DECLARE @p3 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p3, 1, 3, 70), (@p3, 6, 3, 55);

-- Mass
INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('ON_SM_12', N'Serious Mass', N'Sữa tăng cân cho người gầy, cung cấp 1,250 calories và 50g protein mỗi lần dùng.', 1450000, @CatMass, @ManuON, '/images/products/on_serious_mass.jpg');
DECLARE @p4 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p4, 1, 4, 60), (@p4, 2, 4, 40);

INSERT INTO products (sku, name, description, price, sale_price, category_id, manufacturer_id, image_url) VALUES ('MT_MTECH_7', N'Mass-Tech Extreme 2000', N'Cung cấp 80g protein và hơn 2000 calories khi pha với sữa, hỗ trợ tăng cân tối đa.', 1300000, 1250000, @CatMass, @ManuMT, '/images/products/mt_mass_tech.jpg');
DECLARE @p5 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p5, 1, 3, 80), (@p5, 3, 3, 70);

-- Creatine
INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('ON_CRE_300', N'Creatine Powder Micronized', N'Creatine Monohydrate dạng bột siêu mịn, giúp tăng sức mạnh và hiệu suất tập luyện.', 450000, @CatCreatine, @ManuON, '/images/products/on_creatine.jpg');
DECLARE @p6 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p6, 4, 1, 200), (@p6, 4, 2, 150);

INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('MT_CELL_3', N'Cell-Tech', N'Công thức creatine tiên tiến kết hợp carb và alpha lipoic acid để tối ưu hóa sự hấp thụ.', 950000, @CatCreatine, @ManuMT, '/images/products/mt_cell_tech.jpg');
DECLARE @p7 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p7, 5, 2, 50), (@p7, 1, 2, 45);

-- Pre-Workout
INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('BSN_NOX_30', N'N.O.-XPLODE Pre-Workout', N'Tăng cường năng lượng, sức bền và sự tập trung cho một buổi tập bùng nổ.', 750000, @CatPre, @ManuBSN, '/images/products/bsn_no_xplode.jpg');
DECLARE @p8 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p8, 5, 1, 100), (@p8, 4, 1, 90);

INSERT INTO products (sku, name, description, price, sale_price, category_id, manufacturer_id, image_url) VALUES ('MT_VAPOR_X5', N'Vapor X5 Next Gen', N'Pre-workout 5 trong 1 mang lại trải nghiệm cảm giác và hiệu suất tập luyện vượt trội.', 800000, 780000, @CatPre, @ManuMT, '/images/products/mt_vapor_x5.jpg');
DECLARE @p9 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p9, 5, 1, 60), (@p9, 4, 1, 65);

-- BCAA
INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('ON_BCAA_30', N'Gold Standard BCAA', N'Hỗ trợ phục hồi cơ bắp, giảm mệt mỏi trong khi tập luyện.', 650000, @CatBCAA, @ManuON, '/images/products/on_bcaa.jpg');
DECLARE @p10 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p10, 5, 1, 88), (@p10, 3, 1, 78);

-- Thêm 5 sản phẩm thực tế nữa
INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('DY_ELITE_5', N'Dymatize Elite 100% Whey', N'Nguồn protein chất lượng cao, dễ hòa tan và hương vị tuyệt vời.', 1650000, @CatWhey, @ManuDY, '/images/products/dy_elite_whey.jpg');
DECLARE @p11 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p11, 1, 3, 70), (@p11, 2, 3, 60);

INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('BSN_SYNTHA6_5', N'BSN Syntha-6', N'Protein blend đa nguồn, cung cấp protein trải dài, lý tưởng cho việc sử dụng bất kỳ lúc nào.', 1550000, @CatWhey, @ManuBSN, '/images/products/bsn_syntha_6.jpg');
DECLARE @p12 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p12, 1, 3, 90), (@p12, 3, 3, 80);

INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('MP_CRE_250', N'Creatine Monohydrate', N'Creatine Monohydrate tinh khiết từ Myprotein, lựa chọn kinh tế và hiệu quả.', 250000, @CatCreatine, @ManuMP, '/images/products/mp_creatine.jpg');
DECLARE @p13 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p13, 4, 1, 300), (@p13, 4, 2, 200);

INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('ON_PRE_30', N'Gold Standard Pre-Workout', N'Tăng năng lượng và sự tập trung với các thành phần được kiểm chứng khoa học.', 700000, @CatPre, @ManuON, '/images/products/on_pre_workout.jpg');
DECLARE @p14 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p14, 5, 1, 110), (@p14, 2, 1, 95);

INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url) VALUES ('DY_AMINO_30', N'All9 Amino', N'Cung cấp đầy đủ 9 loại EAA cần thiết để tối ưu hóa quá trình tổng hợp protein và phục hồi cơ bắp.', 720000, @CatBCAA, @ManuDY, '/images/products/dy_all9_amino.jpg');
DECLARE @p15 INT = SCOPE_IDENTITY();
INSERT INTO product_variants (product_id, flavour_id, weight_id, stock_quantity) VALUES (@p15, 5, 1, 80), (@p15, 3, 1, 70);

-- 35 SẢN PHẨM NGẪU NHIÊN
DECLARE @ProdCounter INT = 16;
WHILE @ProdCounter <= 50
BEGIN
    DECLARE @RandomCatId INT = (SELECT TOP 1 category_id FROM categories ORDER BY NEWID());
    DECLARE @RandomManId INT = (SELECT TOP 1 manufacturer_id FROM manufacturers ORDER BY NEWID());
    DECLARE @RandomPrice INT = 500000 + (ABS(CHECKSUM(NEWID())) % 1500000);
    DECLARE @ProdName NVARCHAR(100) = (SELECT name FROM categories WHERE category_id = @RandomCatId) + ' GenX ' + CAST(@ProdCounter AS NVARCHAR(10));
    INSERT INTO products (sku, name, description, price, category_id, manufacturer_id, image_url, total_all_time)
    VALUES ('SKU_RND_' + CAST(@ProdCounter AS VARCHAR(10)), @ProdName, N'Mô tả chi tiết cho sản phẩm ' + @ProdName, @RandomPrice, @RandomCatId, @RandomManId, '/images/products/placeholder.jpg', ABS(CHECKSUM(NEWID())) % 5000);
    DECLARE @NewProdId INT = SCOPE_IDENTITY();
    -- Thêm 2-3 biến thể ngẫu nhiên
    DECLARE @v_count INT = 1, @v_max INT = (ABS(CHECKSUM(NEWID())) % 2) + 2;
    WHILE @v_count <= @v_max
    BEGIN
        INSERT INTO product_variants (product_id, flavour_id, weight_id, price, stock_quantity) VALUES (@NewProdId, (SELECT TOP 1 flavour_id FROM flavours ORDER BY NEWID()), (SELECT TOP 1 weight_id FROM weights ORDER BY NEWID()), @RandomPrice + (ABS(CHECKSUM(NEWID())) % 100000 - 50000), ABS(CHECKSUM(NEWID())) % 100);
        SET @v_count = @v_count + 1;
    END;
    SET @ProdCounter = @ProdCounter + 1;
END;
GO

-- Chèn 100 khách hàng và dữ liệu liên quan
PRINT 'Inserting 100 users and related data...';
DECLARE @UserCounter INT = 1;
WHILE @UserCounter <= 100
BEGIN
    INSERT INTO users (username, full_name, email, password_hash, phone, avatar_url, updated_at) VALUES ('customer' + CAST(@UserCounter AS VARCHAR(10)), N'Khách Hàng ' + CAST(@UserCounter AS NVARCHAR(10)), 'customer' + CAST(@UserCounter AS VARCHAR(10)) + '@example.com', 'password123', '09' + FORMAT(ABS(CHECKSUM(NEWID())) % 100000000, '00000000'), 'https://i.pravatar.cc/150?u=' + CAST(@UserCounter AS VARCHAR(10)), DATEADD(day, -(ABS(CHECKSUM(NEWID())) % 30), GETDATE()));
    DECLARE @NewUserId INT = SCOPE_IDENTITY();
    INSERT INTO addresses (user_id, full_name, address, city, province, phone) VALUES (@NewUserId, N'Khách Hàng ' + CAST(@UserCounter AS NVARCHAR(10)), N'Số ' + CAST(ABS(CHECKSUM(NEWID())) % 1000 AS VARCHAR(10)) + N', Đường ABC', N'Hà Nội', N'Miền Bắc', '09' + FORMAT(ABS(CHECKSUM(NEWID())) % 100000000, '00000000'));
    INSERT INTO carts (user_id) VALUES (@NewUserId);
    DECLARE @CartId INT = SCOPE_IDENTITY();
    INSERT INTO cart_items (cart_id, variant_id, quantity) VALUES (@CartId, (SELECT TOP 1 variant_id FROM product_variants ORDER BY NEWID()), 1);
    INSERT INTO cart_items (cart_id, variant_id, quantity) VALUES (@CartId, (SELECT TOP 1 variant_id FROM product_variants ORDER BY NEWID()), 2);
    INSERT INTO wishlists (user_id) VALUES (@NewUserId);
    DECLARE @WishlistId INT = SCOPE_IDENTITY();
    INSERT INTO wishlist_items (wishlist_id, product_id) VALUES (@WishlistId, (SELECT TOP 1 product_id FROM products ORDER BY NEWID()));
    INSERT INTO wishlist_items (wishlist_id, product_id) VALUES (@WishlistId, (SELECT TOP 1 product_id FROM products ORDER BY NEWID()));
    SET @UserCounter = @UserCounter + 1;
END;
GO

-- Chèn 500 đơn hàng (mỗi user 5 đơn)
PRINT 'Inserting 500 orders...';
DECLARE @OrderUserCounter INT = 1;
WHILE @OrderUserCounter <= 100
BEGIN
    DECLARE @OrderCountPerUser INT = 1;
    WHILE @OrderCountPerUser <= 5
    BEGIN
        DECLARE @UserAddressId INT = (SELECT TOP 1 address_id FROM addresses WHERE user_id = @OrderUserCounter);
        DECLARE @OrderStatus NVARCHAR(50) = CASE @OrderCountPerUser WHEN 1 THEN N'hoàn thành' WHEN 2 THEN N'đã thanh toán' WHEN 3 THEN N'chờ thành toán' WHEN 4 THEN N'đã hủy' ELSE N'đã trả' END;
        INSERT INTO orders (user_id, address_id, payment_method_id, delivery_type_id, status, notes)
        VALUES (@OrderUserCounter, @UserAddressId, (SELECT TOP 1 payment_method_id FROM payment_methods ORDER BY NEWID()), (SELECT TOP 1 id FROM delivery_types ORDER BY NEWID()), @OrderStatus, N'Ghi chú cho đơn hàng.');
        DECLARE @NewOrderId INT = SCOPE_IDENTITY();
        DECLARE @OrderItemCount INT = 1, @NumItems INT = (ABS(CHECKSUM(NEWID())) % 3) + 1;
        WHILE @OrderItemCount <= @NumItems
        BEGIN
            INSERT INTO order_items (order_id, variant_id, quantity) VALUES (@NewOrderId, (SELECT TOP 1 variant_id FROM product_variants ORDER BY NEWID()), (ABS(CHECKSUM(NEWID())) % 2) + 1);
            SET @OrderItemCount = @OrderItemCount + 1;
        END;
        SET @OrderCountPerUser = @OrderCountPerUser + 1;
    END;
    SET @OrderUserCounter = @OrderUserCounter + 1;
END;
GO

-- Chèn 1000 reviews và 50 refunds
PRINT 'Inserting 1000 reviews and 50 refunds...';
DECLARE @ReviewCounter INT = 1;
WHILE @ReviewCounter <= 1000
BEGIN
    INSERT INTO reviews (product_id, user_id, rating, comment)
    VALUES (
        (SELECT TOP 1 product_id FROM products ORDER BY NEWID()),
        (SELECT TOP 1 user_id FROM users ORDER BY NEWID()),
        (ABS(CHECKSUM(NEWID())) % 3) + 3, -- Rating từ 3-5 sao
        N'Bình luận rất tích cực về sản phẩm này.'
    );
    SET @ReviewCounter = @ReviewCounter + 1;
END;
GO

INSERT INTO refunds (order_id, reason, status)
SELECT TOP 50 order_id, N'Lý do hoàn trả: Sản phẩm không đúng mô tả.', 'Pending'
FROM orders WHERE status = N'đã trả' ORDER BY NEWID();
GO

PRINT 'All data insertion complete.';
GO